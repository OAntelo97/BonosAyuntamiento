@page "/beneficiarios"
@using BonosAytoService.DTOs
@using BonosAyto.Components.DataTables
@inject NavigationManager Navigate
@using BonosAyto.Components.Modales
@using BonosAyto.Components.Templates
@using BonosAyto.Components.Enums

<ListadoAltaTemplate Tipo="PageType.Beneficiarios"> 
    <RenderAltaFragment>
        <EditForm Model="modeloAlta" OnValidSubmit="@AltaBeneficiario">
            <DataAnnotationsValidator />
            <Microsoft.AspNetCore.Components.Forms.ValidationSummary />

            <label class="form-label" for="nombre">Nombre</label>
            <InputText id="nombre" @bind-Value="modeloAlta.Nombre" class="form-control" placeholder="Nombre" />

            <label for="apellido1" class="mt-3 form-label">Primer Apellido</label>
            <InputText id="apellido1" @bind-Value="modeloAlta.PrimerApellido" class="form-control" placeholder="Primer apellido" />

            <label for="apellido2" class="mt-3 form-label">Segundo Apellido</label>
            <InputText id="apellido2" @bind-Value="modeloAlta.SegundoApellido" class="form-control" placeholder="Segundo apellido" />

            <label for="dni" class="mt-3 form-label">DNI</label>
            <InputText id="dni" @bind-Value="modeloAlta.DNI" class="form-control" placeholder="11111111A" />

            <label for="direccion" class="mt-3 form-label">Dirección</label>
            <InputText id="direccion" @bind-Value="modeloAlta.Direccion" class="form-control" placeholder="Dirección" />

            <label for="cp" class="mt-3 form-label">Código Postal</label>
            <InputNumber id="cp" @bind-Value="modeloAlta.CodigoPostal" class="form-control" />

            <label for="tel" class="mt-3 form-label">Teléfono</label>
            <InputText id="tel" @bind-Value="modeloAlta.Telefono" class="form-control" placeholder="000000000" />

            <label for="email" class="mt-3 form-label">Correo Electrónico</label>
            <InputText id="email" @bind-Value="modeloAlta.Email" class="form-control" placeholder="Correo electrónico" />
            <div class="text-end">
                <button type="submit" class="btn btn-dark mt-4 align-content-end rounded-0">Agregar</button>
            </div>
        </EditForm>

        <hr />
        <div class="card-header bg-primary text-white text-center mb-3">
            <h5 class="my-1">Carga masiva de beneficiarios/as</h5>
        </div>

        <div class="d-flex align-items-center gap-2 bg-light p-1 overflow-hidden">
            <label class="btn btn-light bg-white rounded-0 form-label">
                Seleccionar archivo
                <InputFile OnChange="SeleccionarFichero" accept=".xlsx" class="d-none" />
            </label>
            <span>@(fichero ?? "Sin elección")</span>
        </div>
        @if (mensajeError != null && mensajeError.Any())
        {
            <ul class="text-danger mt-2">
                @foreach (var error in mensajeError)
                {
                    <li>@error</li>
                }
            </ul>
        }

        <a class="mt-2" href="files/PlantillaBeneficiarios.xlsx" download>Descargar plantilla Excel</a>

        <div class="text-end mb-3">
            <button type="submit" class="btn btn-dark mt-4 align-content-end rounded-0" @onclick="CargarExcel">Cargar Excel</button>
        </div>
    </RenderAltaFragment>                  
    <RenderListadoFragment>
        <DataTables>
            <table class="table table-hover align-middle" id="tablaListado">
                <thead class="table-light">
                    <tr>
                        <th class="nombre-columna text-truncate">Nombre</th>
                        <th>Telefono</th>
                        <th>Email</th>
                        <th class=" text-center acciones-columna">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ben in listaBeneficiarios)
                    {
                        <tr>
                            <td class="nombre-columna text-truncate">@($"{ben.Nombre} {ben.PrimerApellido} {ben.SegundoApellido}")</td>
                            <td>@ben.Telefono</td>
                            <td>@ben.Email</td>

                            <td class="text-center acciones-columna">
                                <button class="btn btn-sm btn-outline-info me-1" @onclick="@(() => VerDetalle(ben.Id))">
                                    <i class="bi bi-search" title="Ver detalles"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning me-1" @onclick="@(() => Modificar(ben.Id))">
                                    <i class="bi bi-pencil d-inline-block pen" title="Editar campos"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="@(() => {IdElimunar = ben.Id;AbrirModal("AlertaEliminar");})">
                                    <i class="bi bi-trash" title="Eliminar beneficiario"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </DataTables>

    </RenderListadoFragment>
</ListadoAltaTemplate>
<AlertaModal modalId="AlertaEliminar" color="warning" icono="exclamation-circle">
    <Titulo>Atención</Titulo>
    <Texto>
        Está seguro que quiere eliminar este usuario?
    </Texto>
    <Descripcion>
        Una vez que se elimine el establecimiento, no se podrán revertir los cambios.
    </Descripcion>
    <botonAceptar>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" @onclick="@(async ()=> await Borrar(IdElimunar))">Confirmar</button>
    </botonAceptar>
</AlertaModal>
<AlertaModal modalId="EliminarError" color="danger" icono="exclamation-triangle">
    <Titulo>Atención</Titulo>
    <Texto>
        Error al intentar @tituloError el beneficiario
    </Texto>
    <Descripcion>
        @MensajeErrorEliminar
    </Descripcion>
</AlertaModal>
