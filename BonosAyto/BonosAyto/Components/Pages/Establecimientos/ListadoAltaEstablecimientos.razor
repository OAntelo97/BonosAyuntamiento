@page "/establecimientos"
@using BonosAytoService.DTOs
@inject NavigationManager Navigate
@using BonosAyto.Components.Templates
@using BonosAyto.Components.Enums
@using BonosAyto.Components.DataTables
@* @attribute [Authorize] *@

<ListadoAltaTemplate Tipo="PageType.Establecimientos">
    <RenderAltaFragment>
        <EditForm Model="establecimiento" OnValidSubmit="@GuardarEstablecimiento">
            <DataAnnotationsValidator />

            <label for="nombre">Nombre</label>
            <InputText id="nombre" @bind-Value="establecimiento.Nombre" placeholder="Nombre" class="form-control" />
            <ValidationMessage For="@(() => establecimiento.Nombre)" />

            <label for="dni" class="mt-3">NIF</label>
            <InputText id="dni" @bind-Value="establecimiento.NIF" placeholder="D1111111" class="form-control" />
            <ValidationMessage For="@(() => establecimiento.NIF)" />

            <label for="direccion" class="mt-3">Dirección</label>
            <InputText id="direccion" @bind-Value="establecimiento.Direccion" placeholder="Direción" class="form-control" />

            <label for="cp" class="mt-3">Código Postal</label>
            <InputNumber id="cp" @bind-Value="establecimiento.CodigoPostal" placeholder="11111" class="form-control" />

            <label for="tel" class="mt-3">Teléfono</label>
            <InputText id="tel" @bind-Value="establecimiento.Telefono" placeholder="000000000" class="form-control" />

            <label for="email" class="mt-3">Correo Electrónico</label>
            <InputText id="email" @bind-Value="establecimiento.Email" placeholder="Correo Electrónico" class="form-control" />
            <ValidationMessage For="@(() => establecimiento.Email)" />
            <div class="text-end">
                <button type="submit" class="btn btn-dark mt-4 align-content-end rounded-0">Agregar</button>
            </div>
        </EditForm>

        <hr />
        <div class="card-header bg-primary text-white text-center mb-3">
            <h5 class="my-1">Carga masiva de establecimientos</h5>
        </div>

        <div class="d-flex align-items-center gap-2 bg-light p-1 overflow-hidden">
            <label class="btn btn-light bg-white rounded-0">
                Seleccionar archivo
                <InputFile OnChange="SeleccionarFichero" accept=".xlsx" class="d-none" />
            </label>
            <span>@(fichero ?? "Sin elección")</span>
        </div>
        @foreach (string mensaje in mensajeError)
        {
            <div class="text-danger mt-2">@mensaje</div>
        }

        <a class="mt-2" href="files/PlantillaEstablecimientos.xlsx" download>Descargar plantilla Excel</a>

        <div class="text-end mb-3">
            <button type="submit" class="btn btn-dark mt-4 align-content-end rounded-0" @onclick="CargarExcel">Cargar Excel</button>
        </div>

    </RenderAltaFragment>

    <RenderListadoFragment>
          <DataTables>
                <table class="table table-hover align-middle" id="tablaListado">
                    <thead class="table-light">
                        <tr>
                            <th class="nombre-columna text-truncate">Nombre</th>
                            <th>Telefono</th>
                            <th>Email</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var est in establecimientos)
                        {
                            <tr>
                                <td class="nombre-columna text-truncate">@est.Nombre</td>
                                <td>@est.Telefono</td>
                                <td>@est.Email</td>

                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-info me-1" @onclick="@(() => VerDetalle(est.Id))">
                                        <i class="bi bi-search" title="Ver detalles"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning me-1" @onclick="@(() => Editar(est.Id))">
                                        <i class="bi bi-pencil d-inline-block"  style="transform:scaleX(-1);" title="Editar campos"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="@(() => {IdElimunar = est.Id;AbrirModal("AlertaEliminar");})">
                                        <i class="bi bi-trash" title="Eliminar usuario"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
           </DataTables>

    </RenderListadoFragment>
</ListadoAltaTemplate>
<AlertaModal modalId="AlertaEliminar" color="warning" icono="exclamation-circle">
    <Titulo>Atención</Titulo>
    <Texto>
        Está seguro que quiere eliminar este establecimiento?
    </Texto>
    <Descripcion>
        Una vez que se elimine el establecimiento, no se podrán revertir los cambios.
    </Descripcion>
    <botonAceptar>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" @onclick="@(async ()=> await Eliminar(IdElimunar))">Confirmar</button>
    </botonAceptar>
</AlertaModal>
<AlertaModal modalId="EliminarError" color="danger" icono="exclamation-triangle">
    <Titulo>Atención</Titulo>
    <Texto>
        Error al intentar @tituloError el establecimiento
    </Texto>
    <Descripcion>
        @MensajeErrorEliminar
    </Descripcion>
</AlertaModal>

